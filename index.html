<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Calcula tu Nota</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .card {
      border-radius: 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .result {
      font-size: 1.3rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="card p-4 mx-auto" style="max-width: 700px;">
      <h2 class="text-center mb-4">📘 Calcula tu Nota</h2>
      <form id="formNotas">
        <div id="evaluacionesContainer"></div>

        <div class="d-flex justify-content-between mb-3">
          <button type="button" class="btn btn-success" onclick="agregarEvaluacion()">➕ Agregar evaluación</button>
          <button type="button" class="btn btn-danger" onclick="eliminarEvaluacion()">➖ Eliminar</button>
        </div>

        <div class="mb-3">
          <label class="form-label">Nota deseada para aprobar</label>
          <input type="number" step="0.01" class="form-control" id="notaObjetivo" value="4.5" oninput="guardarDatos()">
        </div>

        <button type="button" class="btn btn-primary w-100" onclick="calcular()">Calcular Nota Necesaria</button>
      </form>

      <div class="mt-4 text-center">
        <p class="result" id="resultado"></p>
      </div>
    </div>
  </div>

  <script>
    let contador = 0;

    // --- Cargar datos guardados al iniciar ---
    window.onload = function() {
      const datosGuardados = JSON.parse(localStorage.getItem("notasData"));
      if (datosGuardados && datosGuardados.evaluaciones.length > 0) {
        datosGuardados.evaluaciones.forEach(e => agregarEvaluacion(e.nota, e.peso));
        document.getElementById("notaObjetivo").value = datosGuardados.notaObjetivo;
      } else {
        for (let i = 0; i < 4; i++) agregarEvaluacion();
      }
    };

    // --- Guardar datos en localStorage ---
    function guardarDatos() {
      const notasInputs = document.querySelectorAll('.nota');
      const pesosInputs = document.querySelectorAll('.peso');
      const notaObjetivo = document.getElementById('notaObjetivo').value;

      const evaluaciones = [];
      for (let i = 0; i < notasInputs.length; i++) {
        evaluaciones.push({
          nota: notasInputs[i].value,
          peso: pesosInputs[i].value
        });
      }

      const datos = { evaluaciones, notaObjetivo };
      localStorage.setItem("notasData", JSON.stringify(datos));
    }

    // --- Agregar una evaluación ---
    function agregarEvaluacion(nota = "", peso = "") {
      contador++;
      const container = document.getElementById('evaluacionesContainer');
      const div = document.createElement('div');
      div.classList.add('row', 'g-2', 'mb-2');
      div.setAttribute('id', `eval-${contador}`);
      div.innerHTML = `
        <div class="col-6">
          <input type="text" class="form-control nota" placeholder="Nota ${contador}" value="${nota}" oninput="formatearNota(this); guardarDatos();">
        </div>
        <div class="col-6">
          <input type="number" step="0.01" class="form-control peso" placeholder="Porcentaje ${contador}" value="${peso}" oninput="guardarDatos()">
        </div>`;
      container.appendChild(div);
      guardarDatos();
    }

    // --- Eliminar la última evaluación ---
    function eliminarEvaluacion() {
      if (contador > 1) {
        const ultima = document.getElementById(`eval-${contador}`);
        ultima.remove();
        contador--;
        guardarDatos();
      }
    }

    // --- Convertir 68 → 6.8 automáticamente ---
    function formatearNota(input) {
      const valor = input.value.replace(/[^0-9]/g, ''); // solo números
      if (valor === '') {
        input.value = '';
        return;
      }
      let numero = parseInt(valor);
      if (numero > 70) numero = 70; // no más de 7.0
      input.value = (numero / 10).toFixed(1);
    }

    // --- Calcular nota necesaria ---
    function calcular() {
      const notasInputs = document.querySelectorAll('.nota');
      const pesosInputs = document.querySelectorAll('.peso');
      const notaObjetivo = parseFloat(document.getElementById('notaObjetivo').value);
      const resultado = document.getElementById('resultado');

      let sumaNotas = 0;
      let pesoPendiente = 0;

      for (let i = 0; i < notasInputs.length; i++) {
        const nota = notasInputs[i].value ? parseFloat(notasInputs[i].value) : null;
        const peso = pesosInputs[i].value ? parseFloat(pesosInputs[i].value) / 100 : 0;

        if (nota !== null && !isNaN(nota)) {
          sumaNotas += nota * peso;
        } else {
          pesoPendiente += peso;
        }
      }

      const notaNecesaria = (notaObjetivo - sumaNotas) / pesoPendiente;

      if (isNaN(notaNecesaria) || pesoPendiente === 0) {
        resultado.textContent = "⚠️ Verifica los datos ingresados (faltan porcentajes o todos los campos están completos).";
        resultado.classList.remove('text-success', 'text-danger');
      } else if (notaNecesaria > 7) {
        resultado.textContent = `Necesitas un ${notaNecesaria.toFixed(2)} 😢 — No es posible alcanzar la nota objetivo.`;
        resultado.classList.add('text-danger');
        resultado.classList.remove('text-success');
      } else if (notaNecesaria < 1) {
        resultado.textContent = `Con tus notas actuales ya pasas 🎉`;
        resultado.classList.add('text-success');
        resultado.classList.remove('text-danger');
      } else {
        resultado.textContent = `Necesitas al menos un ${notaNecesaria.toFixed(2)} en la(s) evaluación(es) faltante(s). 💪`;
        resultado.classList.add('text-success');
        resultado.classList.remove('text-danger');
      }

      guardarDatos();
    }
  </script>
</body>
</html>
